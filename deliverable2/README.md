# Deliverable #2

## Introduction

This document is our written simulation test report. We will submit a separate paper to the IEEE Test AI conference as suggested by the IEEE Test AI Challenge organizers. A copy of that paper is available in this repo for completeness.

In this document, we briefly describe SALVO (Stephan, ALessio and VuOng, our names, but also the Italian word for "safe") for generating interesting and diversified tests from existing maps automatically.

The scripts to generate, filter, and execute the test cases are available in this repo under the folder `scripts`. 
**TODO: check this is the right folder!!**
However, we do not provide any predefined scenarios, trips or routes, as those are automatically derived at runtime by SALVO. Instead, we report examples of generated trips/routes under the folder `trips-routes`. The visualization of the trips correspond to the output of the sample usage commands listed below.
**TODO: check this is the right folder!!**

Simulation execution reports for the selected scenario executions are reported in folder `simulation reports`. 
**TODO: check this is the right folder!!**
We report only a few examples of the driving scenarios generated by SALVO, including scenarios that take place at intersection and involved static obstacles/NPC. 

Links to the videos illustrating SALVO in actions are listed below.
**TODO: Add more videos and descriptions!!**

## SALVO: Automated Generation of Diversified Tests for Self-driving Cars from Existing Maps

**TODO ALESSIO MUST WRITE THIS ONE !!!***
*A (written) simulation test report, which documents the generated test scenarios, classes, scripting methods, simulation test coverage, and problem findings.
: it takes a map in OpenDrive (.xodr) format as input, identify all the intersections in it, generates test cases that make the ego-car junctions*

## Requirements
SALVO is implemented as a Python command line application. It requires Python version 3.7 and the libraries listed in the `requirements.txt` file. 
**TODO CHECK THAT ALL THE PACKAGES AND VERSIONS ARE LISTED HERE**

We tested SALVO on Ubuntu **TODO Add the versions of the OS** running the SVL Simulator version 2021.01 and Apollo 6.0. We used only the SVL Python interface and the following maps:

- Cube Town
- Borregas Avenue
- Shalun
- GoMentum
- San Francisco

**Note:** SALVO requires the .xodr files of the maps, so for simplify we copied those files inside this repo.

**TODO: Add specifications for the ego-car, cyber-bridge, etc.**

## Usage Examples

The following scripts exemplify how to invoke SALVO. The all assume you correctly installed the requirements (and activated the virtual environment).
The visualizations of the trips generated by those command can be found inside the folder `trips-routes`.

This command generates **all** the paths across the intersections that SALVO finds in the given `map-file`. Each path starts a configurable number of meters before the intersection (`before-junction`), crosses the intersection (going straight, turning left or right), and ends a configurable number of meters after it (`after_junction`).
**TODO: Check if parameters are map_file or map-file, usually the format uses the hyphen (-) not the underscore (_)**
In the sample command, we configure SALVO to use the Cube Town map and to start/end paths 20 meters before/after the intersection. Since there are two intersections in the map, each having three incoming roads and two possible directions, this command should generate 12 paths.
 
```
python salvo.py generate-all-paths \
        --map_file CubeTown \
        --before_junction 20 \
        --after_junction 20
```

The following two commands, instead, configure SALVO to filter the generated paths to achieve diversity. The first command uses a greedy heuristic to filter paths that are too similar to each other. The path similarity is computed using the Iterative Levenshtein distance of the (supposed) trajectory of the ego car. Setting a value of 1.9 for the distance, should lead to selecting 8 out of 12 paths.

```
python salvo.py generate-all-paths \
        --map_file CubeTown \
        --before_junction 20 \
        --after_junction 20 \
        --filter distance 1.9 True
```

The second command instead uses the feature maps defined in [1] to characterize the generated paths and filters those paths that cover the same cells of the feature map. In the example command, we configure the map to have 10 cells per feature (for a total of 100 cells in the map). Using this configuration for the CubeTown map, SALVO should produce 5 paths.

```
python salvo.py generate-all-paths \
        --map_file CubeTown \
        --before_junction 20 \
        --after_junction 20 \
        --filter feature 10 True
```

The previous three commands configure SALVO to generate test cases that do not involve any NPC. We allows NPC acting as static obstacles with the following command:

```
python salvo.py generate-all-paths-with-parking \
        --map_file BorregasAve \
        --before_junction 20 \
        --after_junction 20 \
        --parking_distance 5
```
In this example, we configure SALVO to use the Borregas Avenue map, start and end paths at 20 meters from the intersection and placing obstacles at 5 meters from the ego car. Note: In this first implementation of our approach, we do not place NPC after the intersections.

**TODO Check that 5 meters are from the ego car or the intersection... no idea... **


Finally, we enable SALVO to generate test cases that are different in the trajectory and in the presence of static obstacles with the following commands that combine the previous ones:

```
python salvo.py generate-all-paths-with-parking --map_file BorregasAve --before_junction 20 --after_junction 20 --parking_distance 5 --filter distance 1.9 False

python salvo.py generate-all-paths-with-parking --map_file BorregasAve --before_junction 20 --after_junction 20 --parking_distance 5 --filter feature 10 False
```

## Link to Videos
We published several video on YouTube illustrating our approach in action against Apollo Baidu (v.6.0).
**TODO: Check that the version of APOLLO is correct **
In this section, we link those videos and provide a short description of their content.

**TODO: Probably we should add some more videos here!! **
**TODO: Double check that the videos are working fine **

 - [Static Obstacles in CubeTown](https://youtu.be/WLIh9Pv8FcI). This video shows how SALVO created four tests in the CubeTown map to cover various combinations of static object placement: no obstacle, an obstacle in the middle of the lane, and obstacles partially occluding the lane on the left and right sides.

## References
[1] T. Zohdinasab et al., "DeepHyperion: exploring the feature space of deep learning-based systems through illumination search", Proceedings of the 30th ACM SIGSOFT International Symposium on Software Testing and Analysis, ISSTA 2021, 2021, DOI: https://doi.org/10.1145/3460319.3464811
